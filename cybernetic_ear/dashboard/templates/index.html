<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cybernetic Ear Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #1a1a1a; color: #f0f0f0; }
        .container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; }
        .card { background-color: #2a2a2a; padding: 20px; border-radius: 8px; }
        h2 { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>Timbre Stream</h2>
            <canvas id="timbreChart"></canvas>
        </div>
        <div class="card">
            <h2>Rhythm Stream</h2>
            <canvas id="rhythmChart"></canvas>
        </div>
        <div class="card">
            <h2>Harmony Stream</h2>
            <canvas id="harmonyChart"></canvas>
            <canvas id="harmsimChart"></canvas>
            <canvas id="tenneyChart"></canvas>
            <canvas id="subharmChart"></canvas>
        </div>
        <div class="card" style="grid-column: span 3;">
            <h2>Cybernetic Core</h2>
            <div style="display: flex; justify-content: space-around;">
                <div style="width: 45%;">
                    <h3>Agent Attention</h3>
                    <canvas id="attentionChart"></canvas>
                </div>
                <div style="width: 45%;">
                    <h3>Reward Signal</h3>
                    <canvas id="rewardChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + 5001);

        // --- Chart Initialization ---
        const createChart = (ctx, type, data, options) => new Chart(ctx, { type, data, options });

        const timbreChart = createChart(document.getElementById('timbreChart').getContext('2d'), 'bar', {
            labels: ['Centroid', 'Flatness', 'Rolloff', 'Flux'],
            datasets: [{ label: 'Value', data: [0, 0, 0, 0], backgroundColor: 'rgba(75, 192, 192, 0.6)' }]
        });

        const rhythmChart = createChart(document.getElementById('rhythmChart').getContext('2d'), 'bar', {
            labels: ['Beat Salience', 'Syncopation', 'Event Density'],
            datasets: [{ label: 'Value', data: [0, 0, 0], backgroundColor: 'rgba(255, 159, 64, 0.6)' }]
        });

        const harmonyChart = createChart(document.getElementById('harmonyChart').getContext('2d'), 'radar', {
            labels: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
            datasets: [{ label: 'Tonal Context', data: Array(12).fill(0), backgroundColor: 'rgba(153, 102, 255, 0.6)' }]
        });

        const harmsimChart = createChart(document.getElementById('harmsimChart').getContext('2d'), 'line', {
            labels: Array(50).fill(''),
            datasets: [{ label: 'Harmonic Similarity', data: Array(50).fill(0), borderColor: 'rgba(255, 206, 86, 0.6)', fill: false }]
        });

        const tenneyChart = createChart(document.getElementById('tenneyChart').getContext('2d'), 'line', {
            labels: Array(50).fill(''),
            datasets: [{ label: 'Tenney Height', data: Array(50).fill(0), borderColor: 'rgba(54, 162, 235, 0.6)', fill: false }]
        });

        const subharmChart = createChart(document.getElementById('subharmChart').getContext('2d'), 'line', {
            labels: Array(50).fill(''),
            datasets: [{ label: 'Subharmonic Tension', data: Array(50).fill(0), borderColor: 'rgba(255, 99, 132, 0.6)', fill: false }]
        });

        const attentionChart = createChart(document.getElementById('attentionChart').getContext('2d'), 'pie', {
            labels: ['Timbre', 'Rhythm', 'Harmony'],
            datasets: [{ data: [33, 33, 34], backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(153, 102, 255, 0.6)'] }]
        });

        const rewardChart = createChart(document.getElementById('rewardChart').getContext('2d'), 'line', {
            labels: Array(50).fill(''),
            datasets: [{ label: 'Reward', data: Array(50).fill(0), borderColor: 'rgba(255, 99, 132, 0.6)', fill: false }]
        });

        // --- Socket.IO Event Listener ---
        socket.on('update_data', function(data) {
            // Timbre Chart
            timbreChart.data.datasets[0].data = [
                data.features.spectral_centroid,
                data.features.spectral_flatness,
                data.features.spectral_rolloff,
                data.features.spectral_flux
            ];
            timbreChart.update();

            // Rhythm Chart
            rhythmChart.data.datasets[0].data = [
                data.features.beat_salience,
                data.features.syncopation_index,
                data.features.event_density
            ];
            rhythmChart.update();

            // Harmony Chart
            if (data.features.tonal_context) {
                harmonyChart.data.datasets[0].data = data.features.tonal_context.slice(0, 12); // Just major keys for now
                harmonyChart.update();
            }

            // New Harmony Charts
            if (data.features.harmsim) {
                harmsimChart.data.datasets[0].data.push(data.features.harmsim);
                harmsimChart.data.datasets[0].data.shift();
                harmsimChart.update();
            }
            if (data.features.tenney_height) {
                tenneyChart.data.datasets[0].data.push(data.features.tenney_height);
                tenneyChart.data.datasets[0].data.shift();
                tenneyChart.update();
            }
            if (data.features.subharm_tension) {
                subharmChart.data.datasets[0].data.push(data.features.subharm_tension);
                subharmChart.data.datasets[0].data.shift();
                subharmChart.update();
            }

            // Attention Chart
            if (data.agent.attention) {
                attentionChart.data.datasets[0].data = data.agent.attention;
                attentionChart.update();
            }

            // Reward Chart
            rewardChart.data.datasets[0].data.push(data.agent.reward);
            rewardChart.data.datasets[0].data.shift();
            rewardChart.update();
        });
    </script>
</body>
</html>
